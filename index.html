
<!DOCTYPE html>
<html lang="ko" data-version="v10">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>🍳 유튜브 레시피</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="유튜브 쇼츠 레시피를 간편하게 저장하고 검색하세요" />
  <link rel="icon" href="./icon-192x192.png" />
  <link rel="apple-touch-icon" href="./icon-192x192.png" />
  <style>
    :root { --ink:#111827; --muted:#6b7280; --pri:#2563eb; --soft:#f1f5f9; --fav:#374151; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,ui-rounded,'Noto Sans KR',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1000px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#2563eb,#3b82f6);color:#fff;padding:26px 16px;text-align:center;position:relative}
    .header h1{font-size:2em;margin-bottom:6px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .header p{opacity:.95;font-size:.95em}
    .main-content{padding:20px}
    /* Reduced paddings/margins on card boxes */
    .add-section{background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:15px;padding:12px;margin-bottom:12px;border:1px solid #e2e8f0;transition:.3s ease all}
    .url-input-container{position:relative;margin-bottom:8px}
    .url-input{width:100%;padding:10px 116px 10px 12px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;transition:all .3s ease}
    .url-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .add-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;transition:all .2s ease;font-size:14px}
    .add-btn:hover{transform:translateY(-50%) translateY(-1px)}
    .add-btn:disabled{background:#9ca3af;cursor:not-allowed;transform:translateY(-50%)}
    .loading{display:none;text-align:center;color:#6b7280;margin-top:6px}

    /* Toolbar */
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .left-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tool-btn{background:#111827;color:#fff;border:none;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800}
    .tool-btn.secondary{background:#e5e7eb;color:#111827}
    .tool-btn.toggled{box-shadow:inset 0 0 0 2px #111827}
    .sort-select{border:2px solid #e5e7eb;border-radius:999px;padding:8px 12px;background:#fff;font-weight:800}

    /* Search section (card style, reduced spacing) */
    .search-section{background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:15px;padding:12px;margin-bottom:12px;border:1px solid #e2e8f0}
    .search-title{margin:0 0 8px 2px;color:#374151;font-weight:800;font-size:1rem}
    .search-container{position:relative;max-width:650px;margin:0 auto}
    .search-input{width:100%;padding:10px 116px 10px 12px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;transition:all .3s ease}
    .search-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .clear-btn{position:absolute;right:84px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:18px;cursor:pointer;color:#6b7280}
    .search-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:#111827;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}

    /* Top viewed title + line */
    .top-viewed-wrap{margin:4px 0 14px}
    .top-viewed-title{font-weight:800;color:#374151;margin:0 0 6px 2px}
    .top-viewed{padding:8px 12px;background:rgba(255,255,255,.55);border-radius:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#374151;font-weight:700}
    .top-viewed .sep{opacity:.6;margin:0 .5rem}
    .top-link{appearance:none;background:none;border:none;color:#111827;font-weight:800;cursor:pointer;padding:0;margin:0;display:inline;white-space:nowrap}
    .top-link:hover{text-decoration:underline}
    .top-link:focus{outline:2px solid #2563eb;outline-offset:2px;border-radius:4px}
    .views{color:var(--muted);font-weight:700;margin-left:.25rem}

    .recipes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
    .recipe-card{background:#fff;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:hidden;transition:all .2s ease;border:1px solid #e2e8f0;position:relative}
    .recipe-card:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(0,0,0,.15)}
    .recipe-thumbnail{width:100%;height:200px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:48px;position:relative;overflow:hidden}
    .recipe-thumbnail img{width:100%;height:100%;object-fit:cover}
    .play-overlay{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:999px;display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer;backdrop-filter:saturate(180%) blur(8px)}
    .fav-btn{position:absolute;top:12px;right:12px;background:rgba(255,255,255,.9);border:none;border-radius:999px;padding:8px 10px;cursor:pointer;font-size:16px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .fav-btn.active{background:#ffe8a3}
    .recipe-content{padding:16px}
    .recipe-title{font-size:1.05em;font-weight:800;color:#1f2937;margin-bottom:8px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .recipe-date{color:#6b7280;font-size:13px;margin-bottom:12px}
    .recipe-actions{display:flex;gap:8px;align-items:center}
    .yt-btn{flex:1;background:#111827;color:#fff;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .share-btn{background:#f3f4f6;color:#111827;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .delete-btn{background:#f3f4f6;color:#6b7280;border:none;padding:10px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .delete-btn:hover{background:#ef4444;color:#fff}
    .delete-btn.nohover:hover{background:#f3f4f6;color:#6b7280}
    .no-results{text-align:center;padding:36px 16px;color:#6b7280;font-size:1.05em}

    /* Fullscreen Player View */
    .player-view{position:fixed;inset:0;background:#000;color:#fff;z-index:50;display:none;flex-direction:column}
    .player-view.show{display:flex}
    .pv-body{flex:1;display:flex;align-items:center;justify-content:center;padding:0 0 env(safe-area-inset-bottom) 0}
    .pv-iframe-wrap{width:100%;max-width:900px;aspect-ratio:9/16;background:#000}
    .pv-iframe-wrap iframe{width:100%;height:100%;border:0}
    .pv-footer{
      position:absolute;left:0;right:0;
      bottom:calc(env(safe-area-inset-bottom) + 28px);
      display:flex;gap:12px;justify-content:center;
      padding:0 16px;
      background:linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,0));
    }
    .pv-btn{background:var(--fav);color:#fff;border:none;border-radius:999px;
      padding:14px 20px;font-weight:900;cursor:pointer;font-size:16px}
    .pv-btn:active{transform:scale(.98)}

    @media (max-width:768px){
      body{padding:10px}
      .header{padding:18px}
      .main-content{padding:16px}
      .recipes-grid{grid-template-columns:1fr}
      .pv-btn{font-size:15px;padding:13px 18px}
      .pv-footer{bottom:calc(env(safe-area-inset-bottom) + 24px)}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🍳 유튜브 레시피</h1>
      <p>주소추가→ 검색→ 영상 클릭</p>
    </div>

    <div class="main-content">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="left-tools">
          <button id="fav-filter" class="tool-btn secondary" aria-pressed="false">⭐ 즐겨찾기만</button>
          <select id="sort-select" class="sort-select" aria-label="정렬">
            <option value="latest" selected>최신순</option>
            <option value="most_viewed">자주본순</option>
            <option value="favorites_first">즐겨찾기 우선</option>
          </select>
          <button id="install-inline" class="tool-btn secondary" style="display:none">앱 설치</button>
        </div>
      </div>

      <!-- 1) 유튜브 링크 추가 -->
      <div id="add-section" class="add-section">
        <h3 style="margin-bottom:8px;color:#374151">🔗 유튜브 링크 추가</h3>
        <div class="url-input-container">
          <input type="url" id="youtube-url" class="url-input" placeholder="https://youtube.com/shorts/... 또는 https://youtu.be/...">
          <button id="add-btn" class="add-btn">추가</button>
        </div>
        <div id="loading" class="loading">⏳ 제목을 가져오는 중...</div>
      </div>

      <!-- 2) 레시피 검색 -->
      <div class="search-section add-section">
        <h3 class="search-title">🔎 레시피 검색</h3>
        <div class="search-container">
          <input type="text" id="search-input" class="search-input" placeholder="요리명 또는 #태그로 검색 (예: 김치, #국물, #볶음)">
          <button id="clear-btn" class="clear-btn" title="지우기">✕</button>
          <button id="search-btn" class="search-btn">검색</button>
        </div>
      </div>

      <!-- 3) Top 3 most viewed -->
      <div class="top-viewed-wrap">
        <div class="top-viewed-title">최다 시청 순위</div>
        <div id="top-viewed" class="top-viewed" title=""></div>
      </div>

      <!-- 레시피 목록 -->
      <div id="recipes-container">
        <div id="recipes-grid" class="recipes-grid"></div>
        <div id="no-results" class="no-results" style="display:none">
          결과가 없습니다. 다른 키워드나 #태그로 검색해보세요.
        </div>
      </div>
    </div>
  </div>

  <!-- Full-screen player view (no header/title) -->
  <section id="player-view" class="player-view" aria-hidden="true">
    <div class="pv-body">
      <div class="pv-iframe-wrap">
        <iframe id="pv-iframe" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
    <div class="pv-footer">
      <button id="pv-back" class="pv-btn">뒤로</button>
      <button id="pv-fav" class="pv-btn">즐겨찾기</button>
      <button id="pv-share" class="pv-btn">공유</button>
    </div>
  </section>

  <script>
    console.log('유튜브 레시피 loaded v10');
    class YouTubeRecipeApp{
      constructor(){
        this.recipes=this.loadRecipes();
        this.current=null;
        this.onlyFav=false;
        this.sortMode='latest';
        // Fill tags if missing
        let changed=false;
        for(const r of this.recipes){
          if(!Array.isArray(r.tags)) r.tags=[];
          if(r.tags.length===0){
            const g=this.generateTags(r.title||'');
            if(g.length){ r.tags = g; changed = true; }
          }
        }
        if(changed) this.saveRecipes();
        this.init();
      }
      init(){
        this.setupEventListeners();
        this.renderRecipes();
        this.updateTopViewed();
        this.setupPWA();
        if(location.hash.startsWith('#play=')){
          const id = location.hash.split('=')[1];
          if(id) setTimeout(()=>this.openPlayer(id), 0);
        }
        if(location.hash.startsWith('#shared=')){
          const payload = decodeURIComponent(location.hash.slice('#shared='.length));
          setTimeout(()=>this.handleSharedPayload(payload), 0);
        }
        window.addEventListener('hashchange', ()=>{
          if(location.hash.startsWith('#play=')){
            const id = location.hash.split('=')[1];
            if(id) this.openPlayer(id);
          }else if(location.hash.startsWith('#shared=')){
            const payload = decodeURIComponent(location.hash.slice('#shared='.length));
            this.handleSharedPayload(payload);
          }else{
            const pv = document.getElementById('player-view');
            if(pv.classList.contains('show')) this.closePlayer();
          }
        });
      }
      setupEventListeners(){
        document.getElementById('add-btn').addEventListener('click',()=>{this.addRecipe()});
        document.getElementById('youtube-url').addEventListener('keypress',(e)=>{if(e.key==='Enter'){this.addRecipe()}});
        const searchInput=document.getElementById('search-input');
        const doSearch=()=>{this.searchRecipes(searchInput.value)};
        searchInput.addEventListener('input',doSearch);
        document.getElementById('search-btn').addEventListener('click',doSearch);
        document.getElementById('clear-btn').addEventListener('click',()=>{searchInput.value='';this.renderRecipes();searchInput.focus()});

        const favBtn=document.getElementById('fav-filter');
        favBtn.addEventListener('click',()=>{
          this.onlyFav = !this.onlyFav;
          favBtn.classList.toggle('toggled', this.onlyFav);
          favBtn.setAttribute('aria-pressed', String(this.onlyFav));
          this.renderRecipes(searchInput.value);
        });

        const sortSel=document.getElementById('sort-select');
        sortSel.addEventListener('change',(e)=>{
          this.sortMode=e.target.value;
          this.renderRecipes(searchInput.value);
        });

        // Player footer buttons
        document.getElementById('pv-back').addEventListener('click',()=>this.closePlayer());
        document.getElementById('pv-fav').addEventListener('click',()=>this.toggleFavCurrent());
        document.getElementById('pv-share').addEventListener('click',()=>this.shareCurrent());
      }

      // ---- Tag generation ----
      generateTags(title=''){
        const t=(title||'').toLowerCase();
        const pairs=[
          [/국물|탕|전골|찌개|수프/, '국물'],
          [/볶음|볶다|stir|stir-fry|stir fry/, '볶음'],
          [/구이|grill|오븐/, '구이'],
          [/튀김|에어프라이|에어프라이어|air ?fry/, '튀김'],
          [/전자레인지|렌지|microwave/, '전자레인지'],
          [/비건|채식|vegan/, '비건'],
          [/간단|초간단|쉽게|5분|10분|퀵/, '간단'],
          [/매운|매콤|spicy|매운맛/, '매운맛'],
          [/김치/, '김치'],
          [/돼지|삼겹|목살|pork/, '돼지고기'],
          [/소고기|beef|등심|안심|차돌/, '소고기'],
          [/닭|치킨|닭가슴|닭다리|chicken/, '닭고기'],
          [/계란|달걀|egg/, '계란'],
          [/두부|tofu/, '두부'],
          [/밥|rice|비빔밥/, '밥'],
          [/면|파스타|noodle|ramen|라면|국수|우동|파스타/, '면/파스타'],
          [/찜|steam/, '찜'],
          [/전|부침|jeon/, '부침/전'],
          [/카레|커리|curry/, '카레'],
          [/샐러드|salad/, '샐러드'],
          [/떡볶이/, '떡볶이'],
          [/야식|안주|술안주/, '술안주'],
          [/도시락|런치박스|lunch/, '도시락'],
          [/다이어트|저탄수|keto|단백질|protein/, '다이어트'],
          [/디저트|베이킹|쿠키|케이크|빵|dessert|baking/, '디저트']
        ];
        const tags=[];
        for(const [re,tag] of pairs){
          if(re.test(t)) tags.push(tag);
        }
        return Array.from(new Set(tags));
      }

      // Card actions
      openYouTube(id){
        const rec=this.recipes.find(r=>r.id===id);
        if(rec) window.open(rec.url, '_blank');
      }
      async shareRecipe(id){
        const rec=this.recipes.find(r=>r.id===id);
        if(!rec) return;
        const text = rec.title + "\n" + rec.url;
        if(navigator.share){
          try{ await navigator.share({title:rec.title, text:rec.title, url:rec.url}); }
          catch(_){}
        }else{
          await navigator.clipboard.writeText(text);
          alert('링크가 클립보드에 복사되었습니다.');
        }
      }

      async addRecipe(){
        const urlInput=document.getElementById('youtube-url');
        const addBtn=document.getElementById('add-btn');
        const loading=document.getElementById('loading');
        const url=urlInput.value.trim();
        if(!url){alert('유튜브 링크를 입력해주세요.');return;}
        if(!this.isValidYouTubeUrl(url)){alert('올바른 유튜브 링크가 아닙니다.');return;}
        const newVid=this.extractVideoId(url);
        if(this.recipes.some(r=>this.extractVideoId(r.url)===newVid)){alert('이미 저장된 레시피입니다.');return;}
        addBtn.disabled=true;loading.style.display='block';
        try{
          const title=await this.extractTitle(url);
          const videoId=this.extractVideoId(url);
          const thumbnail=`https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
          const recipe={
            id:Date.now().toString(),
            title:title||'제목을 가져올 수 없습니다',
            url,thumbnail,
            createdAt:new Date().toISOString(),
            views:0,favorite:false,
            tags:this.generateTags(title||'')
          };
          this.recipes.unshift(recipe);
          this.saveRecipes();
          this.renderRecipes();
          this.updateTopViewed();
          urlInput.value='';
        }catch(err){
          console.error(err);
          alert('제목을 가져오는데 실패했습니다. 다시 시도해주세요.');
        }finally{
          addBtn.disabled=false;loading.style.display='none';
        }
      }
      async handleSharedPayload(payload){
        const match = (payload||'').match(/https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)[\w-]+/i);
        if(!match){ alert('공유된 내용에서 유튜브 링크를 찾지 못했습니다.'); return; }
        const url = match[0];
        if(this.recipes.some(r=>this.extractVideoId(r.url)===this.extractVideoId(url))){
          const exist = this.recipes.find(r=>this.extractVideoId(r.url)===this.extractVideoId(url));
          if(exist){ this.openPlayer(exist.id); }
          location.hash = ''; 
          return;
        }
        try{
          const title = await this.extractTitle(url);
          const vid = this.extractVideoId(url);
          const thumbnail = `https://img.youtube.com/vi/${vid}/maxresdefault.jpg`;
          const recipe={
            id:Date.now().toString(),title:title||'제목을 가져올 수 없습니다',url,thumbnail,
            createdAt:new Date().toISOString(),views:0,favorite:false,
            tags:this.generateTags(title||'')
          };
          this.recipes.unshift(recipe);
          this.saveRecipes();
          this.renderRecipes();
          this.updateTopViewed();
          this.openPlayer(recipe.id);
        }catch(e){
          console.error(e);
          alert('공유된 링크를 추가하는 중 문제가 발생했습니다.');
        }finally{
          location.hash=''; 
        }
      }
      isValidYouTubeUrl(url){
        const patterns=[/^https?:\/\/(www\.)?youtube\.com\/shorts\/[\w-]+/,/^https?:\/\/(www\.)?youtube\.com\/watch\?v=[\w-]+/,/^https?:\/\/youtu\.be\/[\w-]+/];
        return patterns.some(p=>p.test(url));
      }
      extractVideoId(url){
        const patterns=[/(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]+)/,/(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]+)/,/(?:youtu\.be\/)([a-zA-Z0-9_-]+)/];
        for(const p of patterns){const m=url.match(p);if(m)return m[1];}
        return null;
      }
      async extractTitle(url){
        try{
          const id=this.extractVideoId(url);
          if(!id) throw new Error('Invalid video ID');
          const res=await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
          if(!res.ok) throw new Error('oEmbed fetch failed');
          const data=await res.json();
          return data.title;
        }catch(_){
          const id=this.extractVideoId(url);
          return `유튜브 레시피 (${id||'알 수 없음'})`;
        }
      }
      deleteRecipe(id, evt){
        const btn = evt && evt.currentTarget;
        const confirmDelete = confirm('정말 이 레시피를 삭제하시겠습니까?');
        if(confirmDelete){
          this.recipes=this.recipes.filter(r=>r.id!==id);
          this.saveRecipes();this.renderRecipes();this.updateTopViewed();
        }else{
          if(btn){
            btn.classList.add('nohover');
            btn.blur();
            const off = ()=>{ btn.classList.remove('nohover'); btn.removeEventListener('mouseleave', off); };
            btn.addEventListener('mouseleave', off, { once:true });
          }
        }
      }
      toggleFav(id){
        const r=this.recipes.find(x=>x.id===id);
        if(!r) return;
        r.favorite=!r.favorite;
        this.saveRecipes();
        this.renderRecipes(document.getElementById('search-input').value);
        this.updateTopViewed();
        if(this.current && this.current.id===id){ this.syncPlayerFavBtn(); }
      }
      toggleFavCurrent(){
        if(!this.current) return;
        this.toggleFav(this.current.id);
      }

      // ---- Search (title + tags) ----
      normalize(s){ return (s||'').toLowerCase().trim(); }
      matchByQuery(r, q){
        if(!q) return true;
        const tokens = this.normalize(q).split(/[\s,]+/).filter(Boolean);
        if(tokens.length===0) return true;
        const title = this.normalize(r.title);
        const tags = (r.tags||[]).map(x=>this.normalize(x));
        return tokens.every(term => {
          const t = term.startsWith('#') ? term.slice(1) : term;
          return title.includes(t) || tags.some(tag => tag.includes(t));
        });
      }
      searchRecipes(q){this.renderRecipes(q);}
      sortList(list){
        const mode=this.sortMode;
        if(mode==='most_viewed'){
          return list.sort((a,b)=> (b.views||0)-(a.views||0) || (new Date(b.lastViewedAt||0))-(new Date(a.lastViewedAt||0)) || (new Date(b.createdAt||0))-(new Date(a.createdAt||0)));
        }
        if(mode==='favorites_first'){
          return list.sort((a,b)=> (b.favorite?1:0)-(a.favorite?1:0) || (new Date(b.lastViewedAt||0))-(new Date(a.lastViewedAt||0)) || (new Date(b.createdAt||0))-(new Date(a.createdAt||0)));
        }
        return list.sort((a,b)=> (new Date(b.createdAt||0))-(new Date(a.createdAt||0)));
      }
      renderRecipes(searchQuery=''){
        let list=this.recipes.map(r=>({...r}));
        if(this.onlyFav) list=list.filter(r=>r.favorite);
        if(searchQuery){
          list=list.filter(r=>this.matchByQuery(r, searchQuery));
        }
        list=this.sortList(list);

        const container=document.getElementById('recipes-grid');
        const noResults=document.getElementById('no-results');
        if(list.length===0){
          container.style.display='none';noResults.style.display='block';
          noResults.innerHTML=searchQuery?`"${searchQuery}"에 대한 결과가 없습니다.`:'저장된 레시피가 없습니다. 상단에서 주소를 추가해보세요.';
        }else{
          container.style.display='grid';noResults.style.display='none';
          container.innerHTML=list.map(r=>this.createRecipeCard(r)).join('');
        }
      }
      createRecipeCard(r){
        const date=new Date(r.createdAt).toLocaleDateString('ko-KR');
        const id=this.extractVideoId(r.url) || '';
        const favClass = r.favorite ? 'fav-btn active' : 'fav-btn';
        const favLabel = r.favorite ? '⭐' : '☆';
        return `
          <div class="recipe-card">
            <div class="recipe-thumbnail" onclick="app.openPlayer('${r.id}')">
              <img src="${r.thumbnail}" alt="${r.title}"
                onerror="this.onerror=null; this.src='https://img.youtube.com/vi/${id}/hqdefault.jpg';">
              <button class="${favClass}" onclick="event.stopPropagation(); app.toggleFav('${r.id}')" aria-pressed="${r.favorite}">${favLabel}</button>
              <div class="play-overlay">▶ 재생</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title" title="${r.title}">${r.title}</h3>
              <div class="recipe-date">저장일: ${date}${r.views?` · 재생 ${r.views}`:''}</div>
              <div class="recipe-actions">
                <button class="yt-btn" onclick="app.openYouTube('${r.id}')">유튜브로 보기</button>
                <button class="share-btn" onclick="app.shareRecipe('${r.id}')">공유</button>
                <button class="delete-btn" onclick="app.deleteRecipe('${r.id}', event)" title="삭제">🗑️</button>
              </div>
            </div>
          </div>`;
      }

      // ===== Top viewed =====
      escapeHtml(s){
        return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }
      updateTopViewed(){
        const el=document.getElementById('top-viewed');
        if(!el) return;
        const top = this.recipes
          .map(r => ({...r, views: r.views || 0}))
          .filter(r => r.views > 0)
          .sort((a,b)=> (b.views - a.views) || (new Date(b.lastViewedAt||0) - new Date(a.lastViewedAt||0)))
          .slice(0,3);

        if(top.length === 0){
          el.innerHTML = '<span>1)</span> <span class="sep">·</span> <span>2)</span> <span class="sep">·</span> <span>3)</span>';
          el.title = "재생 기록이 없습니다";
          return;
        }
        const parts = top.map((r,i)=> {
          const title = this.escapeHtml(r.title);
          const count = r.views || 0;
          return `<button class="top-link" onclick="app.openPlayer('${r.id}')" title="${title}">${i+1}) ${title} <span class="views">(${count})</span></button>`;
        });
        el.innerHTML = parts.join('<span class="sep">·</span>');
        el.title = top.map((r,i)=> `${i+1}) ${r.title} (${r.views||0})`).join(" | ");
      }

      // ===== Player view =====
      openPlayer(id){
        const rec=this.recipes.find(r=>r.id===id);
        if(!rec) return;
        rec.views = (rec.views || 0) + 1;
        rec.lastViewedAt = new Date().toISOString();
        this.saveRecipes();
        this.updateTopViewed();

        this.current=rec;
        const pv=document.getElementById('player-view');
        const iframe=document.getElementById('pv-iframe');
        const vid=this.extractVideoId(rec.url);
        const embed = `https://www.youtube.com/embed/${vid}?autoplay=1&modestbranding=1&rel=0&playsinline=1`;
        iframe.src=embed;
        pv.classList.add('show');
        pv.setAttribute('aria-hidden','false');
        history.pushState(null, '', '#play='+id);
        document.documentElement.style.overflow='hidden';
        document.body.style.overflow='hidden';
        this.syncPlayerFavBtn();
      }
      closePlayer(){
        const pv=document.getElementById('player-view');
        const iframe=document.getElementById('pv-iframe');
        pv.classList.remove('show');
        pv.setAttribute('aria-hidden','true');
        iframe.src='';
        if(location.hash.startsWith('#play=')){
          history.pushState('', document.title, window.location.pathname + window.location.search);
        }
        document.documentElement.style.overflow='';
        document.body.style.overflow='';
      }
      syncPlayerFavBtn(){
        const btn=document.getElementById('pv-fav');
        if(!btn || !this.current) return;
        btn.textContent = (this.current?.favorite ? '⭐ ' : '☆ ') + '즐겨찾기';
      }
      async shareCurrent(){
        if(!this.current) return;
        const text = this.current.title + "\n" + this.current.url;
        if(navigator.share){
          try{ await navigator.share({title:this.current.title, text:this.current.title, url:this.current.url}); }
          catch(_){}
        }else{
          await navigator.clipboard.writeText(text);
          alert('링크가 클립보드에 복사되었습니다.');
        }
      }

      // ===== Storage =====
      loadRecipes(){
        try{const s=localStorage.getItem('youtubeRecipes');return s?JSON.parse(s):[]}catch{return []}
      }
      saveRecipes(){
        try{localStorage.setItem('youtubeRecipes',JSON.stringify(this.recipes));}catch(e){console.error('저장 중 오류:',e);}
      }

      // ===== PWA =====
      setupPWA(){
        let deferredPrompt;
        const installBtn=document.getElementById('install-inline');
        window.addEventListener('beforeinstallprompt',(e)=>{
          e.preventDefault();
          deferredPrompt=e;
          installBtn.style.display='inline-flex';
        });
        installBtn?.addEventListener('click',async()=>{
          if(!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt=null;
          installBtn.style.display='none';
        });
        window.addEventListener('appinstalled',()=>{ installBtn.style.display='none'; });
        if('serviceWorker' in navigator){
          window.addEventListener('load',()=>{
            navigator.serviceWorker.register('sw.js').catch(err=>console.log('SW registration failed',err));
          });
        }
      }
    }
    const app=new YouTubeRecipeApp();
  </script>
</body>
</html>
